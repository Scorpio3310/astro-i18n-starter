---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import Base from "@layouts/Base.astro";
import { Image } from "astro:assets";
import { formatDate } from "@utils/utils";
import { useTranslations, useTranslatedPath } from "@i18n/utils";
import Pagination from "@components/Pagination.astro";

export const getStaticPaths = (async () => {
    const posts = await getCollection("blog", (entry) => !entry.data.isDraft);
    const authorsRaw = await getCollection("authors");

    // Define how many posts per page
    const PAGE_SIZE = 4;

    // Languages configuration
    const languages = [
        {
            code: "en",
            prefix: "en/",
            pagination: "blog-pagination",
            slug: undefined,
        },
        {
            code: "sl",
            prefix: "sl/",
            pagination: "sl",
            slug: "spletni-dnevnik-paginacija",
        },
    ];

    return languages.flatMap(({ code, prefix, pagination, slug }) => {
        // Filter and sort posts for this language
        const filteredPosts = posts
            .filter((post) => post.id.startsWith(prefix))
            .sort(
                (a, b) =>
                    new Date(b.data.pubDate).getTime() -
                    new Date(a.data.pubDate).getTime()
            );

        // Get localized authors
        const authors = authorsRaw.map((a) => ({
            ...a,
            data: {
                ...a.data,
                position: a.data.position?.[code] ?? a.data.position?.en ?? "",
            },
        }));

        // Generate pagination paths - ensure at least one page even if no posts
        const totalPages = Math.max(
            1,
            Math.ceil(filteredPosts.length / PAGE_SIZE)
        );

        return Array.from({ length: totalPages }, (_, index) => {
            const pageNum = index + 1;
            const start = index * PAGE_SIZE;
            const postsForPage = filteredPosts.slice(start, start + PAGE_SIZE);

            return {
                params: {
                    pagination,
                    slug:
                        pageNum === 1
                            ? slug
                            : slug
                              ? `${slug}/${pageNum}`
                              : `${pageNum}`,
                },
                props: {
                    lang: code,
                    posts: postsForPage,
                    authors,
                    currentPage: pageNum,
                    totalPages,
                    totalPosts: filteredPosts.length,
                },
            };
        });
    });
}) satisfies GetStaticPaths;

const { posts, lang, authors, currentPage, totalPages, totalPosts } =
    Astro.props;

const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
---

<Base
    title={t("blog:head.title")}
    meta={{
        description: t("blog:head.description"),
    }}
>
    <section>
        <h1>{t("blog:title")}</h1>
        <p class="text-2xl font-semibold mb-4 text-center">
            {t("blog:descriptionPagination")}
        </p>
        <p class="text-lg font-semibold mb-4 text-center">
            {t("blog:totalPosts", { count: totalPosts })}
        </p>
        <section class="space-y-10">
            {
                posts.length > 0 ? (
                    posts.map((post) => {
                        const author = authors.find(
                            (a) => a.id === post.data.author.id
                        );
                        return (
                            <article class="card-blog">
                                <a
                                    href={`${translatePath("/blog")}/${post.id.split("/")[1]}`}
                                >
                                    <Image
                                        src={post.data.image}
                                        alt={
                                            post.data.imageAlt ||
                                            post.data.title
                                        }
                                        class="image"
                                        loading="lazy"
                                        quality={"high"}
                                        sizes="(min-width: 1024px) 800px, 100vw"
                                    />
                                    <div class="text">
                                        <p class="date">
                                            {formatDate(post.data.pubDate)}
                                        </p>

                                        <div class="author">
                                            <Image
                                                src={author?.data?.image}
                                                alt={author?.data?.name}
                                                height={36}
                                                width={36}
                                                loading="lazy"
                                                quality={"mid"}
                                                class="rounded-full"
                                            />
                                            <div>
                                                <h3>{author?.data?.name}</h3>
                                                <p class="position">
                                                    {author?.data?.position}
                                                </p>
                                            </div>
                                        </div>

                                        <h2>{post.data.title}</h2>
                                        <p>{post.data.description}</p>
                                        <div class="w-fit">
                                            <p class="button">
                                                {t("blog:readMore")} â†’
                                            </p>
                                        </div>
                                    </div>
                                </a>
                            </article>
                        );
                    })
                ) : (
                    <p class="text-center opacity-50">{t("blog:noPosts")}</p>
                )
            }
        </section>

        <Pagination
            lang={lang}
            currentPage={currentPage}
            totalPages={totalPages}
            basePath="/blog-pagination"
        />
    </section>
</Base>
